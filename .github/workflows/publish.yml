name: Publish Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., v1.0.0)"
        required: true
        type: string
      skip_build:
        description: "Skip binary building (library mode)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true
          cache-dependency-path: go.sum

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Verify Version Format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: v1.0.0"
            exit 1
          fi

      - name: Run Tests
        run: |
          echo "ðŸ§ª Running tests..."
          go test -v ./...

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Release ${{ steps.version.outputs.version }}"
          body: |
            ## ðŸš€ Release ${{ steps.version.outputs.version }}

            ### ðŸ“¦ Changes
            - Automated release from tag ${{ steps.version.outputs.version }}

            ### ðŸ”— Installation
            ```bash
            go get github.com/package-register/trpc-agent-go-extensions@${{ steps.version.outputs.version }}
            ```

            ### ðŸ“‹ Modules
            - **build**: Cross-platform build tools
            - **cache**: In-memory caching with concurrency safety
            - **docker**: Docker image building and container management
            - **gitops**: Version tagging and automated release pipelines
            - **rod**: Browser automation utilities
            - **trans**: Translation service integration
            - **image**: Image processing and timetable generation
            - **discovery**: Network service discovery
            - **zerotier**: ZeroTier network management API

            ---
            ðŸ¦„ Made with â¤ï¸ by oAo Team
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: Build Binaries
    runs-on: ubuntu-latest
    needs: release
    if: false # é»˜è®¤è·³è¿‡äºŒè¿›åˆ¶æž„å»º
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true
          cache-dependency-path: go.sum

      - name: Build Binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          VERSION="${{ needs.release.outputs.version }}"

          # Set binary name based on OS
          if [ "$GOOS" = "windows" ]; then
            BINARY_NAME="trpc-agent-go-extensions-${VERSION}-${GOOS}-${GOARCH}.exe"
          else
            BINARY_NAME="trpc-agent-go-extensions-${VERSION}-${GOOS}-${GOARCH}"
          fi

          echo "Building for $GOOS/$GOARCH..."

          # Create library package instead of binary
          mkdir -p dist
          echo "# TRPC Agent Go Extensions $VERSION" > "dist/README.md"
          echo "Installation: go get github.com/package-register/trpc-agent-go-extensions@$VERSION" >> "dist/README.md"
          echo "" >> "dist/README.md"
          echo "## Modules" >> "dist/README.md"
          echo "- build: Cross-platform build tools" >> "dist/README.md"
          echo "- cache: In-memory caching with concurrency safety" >> "dist/README.md"
          echo "- docker: Docker image building and container management" >> "dist/README.md"
          echo "- gitops: Version tagging and automated release pipelines" >> "dist/README.md"
          echo "- rod: Browser automation utilities" >> "dist/README.md"
          echo "- trans: Translation service integration" >> "dist/README.md"
          echo "- image: Image processing and timetable generation" >> "dist/README.md"
          echo "- discovery: Network service discovery" >> "dist/README.md"
          echo "- zerotier: ZeroTier network management API" >> "dist/README.md"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-go-mod:
    name: Update Go Module
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true
          cache-dependency-path: go.sum

      - name: Update Go Module
        run: |
          VERSION="${{ needs.release.outputs.version }}"

          # Update go.mod with new version
          echo "Updating go.mod for version $VERSION"

          # Tidy dependencies
          go mod tidy

          # Commit changes if any
          if [[ -n $(git status --porcelain) ]]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add go.mod go.sum
            git commit -m "chore: update go.mod for v$VERSION"
            git push
          fi

      - name: Trigger Go module reindex
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          echo "Triggering Go module reindex at proxy.golang.org"
          curl -sSf "https://proxy.golang.org/github.com/${{ github.repository }}/@v/${VERSION}.info" || true

  notify:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [release, update-go-mod]
    if: always()

    steps:
      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "go get github.com/package-register/trpc-agent-go-extensions@${{ needs.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
